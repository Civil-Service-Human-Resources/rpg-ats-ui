if(void 0===WCN)var WCN={};WCN.ns=function(){var e=arguments,a=null,t,d,n;for(t=0;t<e.length;t+=1)for(n=e[t].split("."),a=window,d=0;d<n.length;d+=1)a[n[d]]=a[n[d]]||{},a=a[n[d]];return a},WCN.ns("WCN.labels"),void 0!==WCN&&WCN||(WCN={}),WCN.constraint={add_word_length:function(e,a){a=parseInt(a,10);var t=$("#"+e),d=function(t){"string"!=typeof t&&(t="");var d=t.replace(/^\s+/,"").replace(/\s+$/,"").split(/\s+/),n=d.length;""===d&&(n=0),n>a?$("#"+e+"_counter").html('<span class="page_error" style="display:inline">'+n+"</span>"):$("#"+e+"_counter").html(n)};t.hasClass("bbcode")&&tinyMCE.getInstanceById(e)?WCN.Watcher(function(){return tinyMCE.getInstanceById(e).getContent()},d):t.watchChange(d)},add_char_length:function(e,a){WCN.log("add_char_length : "+e);var t=$("#"+e);$("#"+e).keyup(function(){var d=t.val(),n=d.length;n>a&&(d=d.substring(0,a),t.val(d),n=a),$("#"+e+"_counter").text(n)}),t.trigger("keyup")}},WCN.dynviz={added_ev_handler:new Array,reinit_for_real:function(){WCN.dynviz.eForms||(this.added_ev_handler=[],this.initialise())},initialise:function(){if(WCN.dynviz.data){var e=function(e){1!=WCN.dynviz.added_ev_handler[e]&&($("#"+e).change(function(e){WCN.dynviz.update_fields()}),$("input[name="+e+"]:radio").click(function(e){WCN.dynviz.update_fields()}),$("input[name="+e+"]:checkbox").click(function(e){WCN.dynviz.update_fields()}),WCN.dynviz.added_ev_handler[e]=!0)},a=/^(.+).formdata.(\d+):(\d+|any|current):(\d+|any|current).(.+)$/;for(var t in WCN.dynviz.data.dtrees)for(var d in WCN.dynviz.data.dtrees[t].dpaths){var n=a.exec(d),i=n[1],o=n[2],r=n[3],l=WCN.dynviz.data.form_instance,s=n[5];if("current"==r)for(var f=1;f<1e3;f++){var p=i+".formdata."+o+":"+f+":"+l+"."+s,_;if(!(_=WCN.dynviz.data.dpath_to_dfield[p]))break;e(_)}else{var p=i+".formdata."+o+":"+r+":"+l+"."+s,_;(_=WCN.dynviz.data.dpath_to_dfield[p])&&e(_)}}WCN.dynviz.update_fields()}},update_fields:function(){for(var e in WCN.dynviz.data.dtrees)if(WCN.dynviz.data.dtrees[e]&&WCN.dynviz.data.dtrees[e].formlet_comps)for(var a=0;a<WCN.dynviz.data.dtrees[e].formlet_comps.length;a++){var t=WCN.dynviz.data.dtrees[e].expression,d,n=WCN.dynviz.data.dtrees[e].formlet_comps[a].split("_",2)[1],i=WCN.dynviz.data.form_instance;t=(t=t.replace(/formdata.(\d+):(\d+|current):(current)./g,"formdata.$1:$2:"+i+".")).replace(/formdata.(\d+):(current):/g,"formdata.$1:"+n+":");var o="#formlet_component_"+WCN.dynviz.data.dtrees[e].formlet_comps[a];WCN.dynviz._evaluate_expresion(t)?($(o+" :input").attr("disabled",!1),$(o).show()):($(o+" :input").attr("disabled",!0),$(o).hide())}$("form.eform_form").trigger("eform.update_vizability")},doIN:function(e,a){for(var t=0;t<a.length;t++)if(a[t]==e)return 1;return 0},runDEFINED:function(e){return WCN.dynviz.get_value_with_dpath(e)?1:0},runAVG:function(e){for(var a=0,t=0,d=0;d<e.length;d++)null!=e[d]&&(a+=1,t+=e[d]);return 0==a?0:t/a},runSUM:function(e){for(var a=0,t=0;t<e.length;t++)null!=e[t]&&(a+=e[t]);return a},_evaluate_expresion:function(expression){return eval(expression)},get_value_with_dpath:function(e){var a=WCN.dynviz.data.dpath_to_dfield[e],t=String(WCN.formtools.get_field_values(a));if("-1"!==t)return t}};var df_re=new RegExp("datafield_(\\d+)_(\\d+)_(\\d+)");WCN.map={df_field_ids:new Array,field_options:new Array,added_ev_handler:new Object,map_data_fields:new Object,get_df_values:function(e,a,t,d){var n=[],i={},o={},r=e.datafield_to_lookup_map[a];e:for(var l in e.map){var s=e.map[l];if(!("pref_set"===e.type&&1==WCN.map_enable_unique&&e.unique_col&&s[e.unique_col]&&e.unique[s[e.unique_col]]&&e.unique[s[e.unique_col]]!==d)){for(var f in e.depends[a]){var p=e.depends[a][f];if(p!==r)for(var _ in e.lookup_to_datafield_map[p]){var u=e.lookup_to_datafield_map[p][_];if(void 0===o[u]){var m=WCN.formtools.get_smallest_datafield(u,t,d);null==m&&(m=""),o[u]=m}var v=o[u];if(v){var c=v.attr("id"),C,C;if(void 0===i[c])null==(C=v.filter("div").length>0?""+v.data("field_value"):v.val())&&(C=""),i[c]=C;if("object"==typeof(C=i[c])){for(var N=!1,W=0;W<C.length;W++)if(C[W]==s[p]){N=!0;break}if(!N)continue e}else if(s[p]!==C)continue e}}}n.push(s[r])}}return n},add_map_handler:function(e,a,t,d){var n=df_re.exec(e),i=n[1],o=n[2],r=n[3],l=$("input[name=_redis_form_session_id]",$("#"+e).closest("form")).val();for(var s in WCN.map.data){if(WCN.map.map_data_fields[s]||(WCN.map.map_data_fields[s]=new Object),1!==WCN.map.data[s].init){if("pref_set"===WCN.map.data[s].type&&1==WCN.map_enable_unique)for(var f in WCN.map.data[s].unique={},WCN.map.data[s].unique_col="id",WCN.map.data[s].depends_most=null,WCN.map.data[s].depends_least=null,WCN.map.data[s].depends)($("#datafield_"+f+"_1_1").parent().parent().parent().hasClass("mandatory")||$("#datafield_"+f+"_1_1").parent().parent().hasClass("mandatory"))&&(WCN.map.data[s].depends_most?(WCN.map.data[s].depends[f].length>WCN.map.data[s].depends[WCN.map.data[s].depends_most].length&&(WCN.map.data[s].depends_most=f),WCN.map.data[s].depends_least?WCN.map.data[s].depends[f].length<WCN.map.data[s].depends[WCN.map.data[s].depends_least].length&&(WCN.map.data[s].depends_least=f):WCN.map.data[s].depends_least=f):WCN.map.data[s].depends_most=f);WCN.map.data[s].init=1}if(WCN.map.data[s].datafield_to_lookup_map[i]){if(WCN.map.map_data_fields[s][e]=1,!WCN.map.data[s].depends[i])continue;for(var p=0;p<WCN.map.data[s].depends[i].length;p++)for(var _=WCN.map.data[s].depends[i][p],u=0;u<WCN.map.data[s].lookup_to_datafield_map[_].length;u++){var m=WCN.map.data[s].lookup_to_datafield_map[_][u],v=WCN.formtools.get_smallest_datafield(m,o,r);v&&function(a,t){if(1!==WCN.map.data[a].eform||!d||!WCN.map.data[a].is_big_map&&WCN.map.data[a].map&&0!==WCN.map.data[a].map.length)v.change(function(t,d){WCN.console.info("This "+t.target.id+" has been changed. We need to update "+e+" according to map "+a);var n=df_re.exec(t.target.id),l=n[1],s=n[2],f=n[3],p=WCN.map.get_df_values(WCN.map.data[a],i,o,r);WCN.formtools.set_field_options(e,p),$("form.eform_form").trigger("eform.field_viz_change")});else{if(WCN.map.added_ev_handler[v.attr("id")])return;v.change(function(e,a){if(WCN.console.info("This "+e.target.id+" has been changed. We will make an AJAX call to fetch updated data for all fields"),void 0!==a||a||(a={}),!a.first_run){var t={};l&&(t._redis_form_session_id=l),t[e.target.id]=WCN.formtools.get_field_values(e.target.id),void 0!==t[e.target.id]&&0!==t[e.target.id].length||(t[e.target.id]=[" "]),WCN.ajax({url:d+WCN.eform_page,dataType:"json",type:"post",data:t,success:function(e){var a=new RegExp("(\\d+)_(\\d+)_(\\d+)");for(var t in e)for(var d=a.exec(t),n=d[1],i=parseInt(d[3]);i<1e3;){var r="datafield_"+n+"_"+o+"_"+i,l="datafield_"+m+"_"+o+"_"+i,s=$("#"+r)[0],f=$("#"+l)[0];if(!s||f&&l!=v.attr("id"))break;WCN.formtools.new_select_values(r,e[t]),$("#"+r).parent().fadeOut(function(){$(this).fadeIn()}),i+=1}$("form.eform_form").trigger("eform.field_viz_change")}})}})}WCN.map.added_ev_handler[v.attr("id")]=v}(s,_)}if("pref_set"===WCN.map.data[s].type&&WCN.map.data[s].depends_most&&WCN.map.data[s].depends_most===i){var c=s;$("#"+e).change(function(e){return function(a,t){WCN.log("Calling Update Unique Cols : "+i+" ("+e+")"),WCN.map.update_unique_cols(WCN.map.data[e],$(this).attr("id"))}}(s))}}}},update_unique_cols:function(e,a){var t,d=(t=df_re.exec(a))[1],n=t[2],i=t[3],o=0,r=null;WCN.log("UPDATE UNIQUE COLS: '"+d+"' => '"+n+"' => '"+i+"'");var l="datafield_"+e.depends_most+"_"+n+"_"+i,s=WCN.formtools.get_field_values(l),f={},p=0,_=0;if(s.length>0)for(var m in f[e.depends_most]=s,p++,e.depends[e.depends_most]){var v=WCN.map.lookup_to_df(e,e.depends[e.depends_most][m])[0],c=WCN.formtools.get_smallest_datafield(v,n,i);if(c)if(c.closest(".form_value").is(":visible")){var C=WCN.formtools.get_field_values(c.attr("id"));C.length>0&&(p++,f[v]=C)}else _++}if(p+_<e.depends[e.depends_most].length+1)for(u in e.unique)e.unique[u]===i&&(delete e.unique[u],o=1);else e:for(var N in e.map){for(var m in e.map[N]){var a;if((a=WCN.map.lookup_to_df(e,m))&&(void 0!==f[a=a[0]]&&f[a])){var W=0;for(var g in f[a])e.map[N][m]===f[a][g]&&(W=1);if(0===W)continue e}}if(e.unique[e.map[N][e.unique_col]]!==i){for(var m in e.unique[e.map[N][e.unique_col]]=i,o=1,e.unique)e.unique[m]===i&&m!==e.map[N][e.unique_col]&&delete e.unique[m];break e}}if(o)for(var a in WCN.map.added_ev_handler){var h,t,y=(t=new RegExp("datafield_(\\d+)_(\\d+)_(\\d+)").exec(a))[1],$=t[2],b=t[3];if(void 0!==e.datafield_to_lookup_map[y]){if(b!==i){var k=WCN.map.get_df_values(e,y,$,b);WCN.formtools.set_field_options(a,k)}}else WCN.log("Skipping df "+y+" as it's not in this map.")}},update_fields:function(){for(var e in WCN.log("----- Running update fields"),WCN.map.map_data_fields)for(var a in WCN.map.map_data_fields[e]){var t=$("#"+a);(t.closest(".form_value").is(":visible")||t.parent().parent().hasClass("use_hidden_map_field"))&&t.trigger("change",[{first_run:1}])}var d=new Array,n=new Array;for(var i in WCN.map.data)for(var o in WCN.map.data[i].depends){var r=WCN.map.df_field_ids[o];for(var l in r){var s=r[l].id,f=r[l].instance,p=$("#"+s);p.hide(),p.parent().append("<div>Loading...</div>");var _=1;for(x=0;x<WCN.map.data[i].depends[o].length;x++){var u=WCN.map.lookup_to_df(i,WCN.map.data[i].depends[o][x]),m=0;if(WCN.map.df_field_ids[u]){for(var v=0,c,C=0,N;C<WCN.map.df_field_ids[u].length;C++){var N;if(1==WCN.map.df_field_ids[u][C].instance&&(c=WCN.map.df_field_ids[u][C]),WCN.map.df_field_ids[u][C].instance===f)v=1,(N=WCN.formtools.get_field_values(WCN.map.df_field_ids[u][C].id)).length>0&&(m=1)}if(0===v&&1!=f&&c)(N=WCN.formtools.get_field_values(c.id)).length>0&&(m=1)}0==m&&(_=0)}if(_)for(var W in WCN.map.data[i].map){for(var g=WCN.map.data[i].map[W],h=1,y=0;y<WCN.map.data[i].depends[o].length;y++){for(var u=WCN.map.lookup_to_df(i,WCN.map.data[i].depends[o][y]),N=[],b=WCN.map.df_to_lookup(i,u),v=0,c,C=0;C<WCN.map.df_field_ids[u].length;C++)1==WCN.map.df_field_ids[u][C].instance&&(c=WCN.map.df_field_ids[u][C]),WCN.map.df_field_ids[u][C].instance===f&&(N=WCN.formtools.get_field_values(WCN.map.df_field_ids[u][C].id),v=1);0===v&&1!=f&&c&&(N=WCN.formtools.get_field_values(c.id));for(var k=0;k<N.length;k++){var w=0;g[b]==N[k]&&(w=1),1!=w&&(h=0)}}if(h){var b,z=g[b=WCN.map.df_to_lookup(i,o)];void 0!==n[s]&&n[s]?n[s].push(z):(n[s]=new Array,n[s].push(z))}else void 0!==n[s]&&n[s]||(n[s]=[])}else window.setTimeout(function(){$("#"+s).show(),$("#"+s).get(0).disabled=!0,$("#"+s).parent().children().remove("div")},500)}}for(var x=0;x<n.length;x++)WCN.log("updating data field "+l),n[x].length>0?WCN.formtools.set_field_options(l,n[x]):$("#"+l).get(0).disabled=!0,window.setTimeout(function(){var e=$("#"+l);e.show(),e.get(0).disabled=!1,e.parent().children().remove("div")},500);$("form.eform_form").trigger("eform.field_viz_change")},lookup_to_df:function(e,a){var t;return(t="object"==typeof e?e:WCN.map.data[e]).lookup_to_datafield_map[a]},df_to_lookup:function(e,a){var t;return WCN.map.data[e].datafield_to_lookup_map[a]}},WCN.formtools={get_smallest_datafield:function(e,a,t){for(;t>=1;){var d=document.getElementById("datafield_"+e+"_"+a+"_"+t);if(null!=d)return $(d);t-=1}return null},set_field_options:function(e,a){var t=$("#"+e),d=t.get(0);if(void 0!==d){d.disabled=!1;var n=WCN.formtools.get_field_values(e);if("select-one"==d.type||"select-multiple"==d.type){if(void 0!==WCN.map.field_options[e]&&WCN.map.field_options[e])for(var i=0;i<WCN.map.field_options[e].length;i++)WCN.map.field_options[e][i].added="0";else{WCN.map.field_options[e]=new Array;for(var i=0;i<d.options.length;i++)if(d.options[i].value){var o={value:d.options[i].value,label:d.options[i].text,added:"0"};WCN.map.field_options[e].push(o)}}var r;r=d&&d.options&&d.options[0]&&d.options[0].innerHTML&&""===d.options[0].value?['<option value="">',d.options[0].innerHTML,"</option>"]:[];for(var i=0;i<WCN.map.field_options[e].length;i++)for(var l=0;l<a.length;l++)if(WCN.map.field_options[e][i].value==a[l]&&"0"==WCN.map.field_options[e][i].added){r.push('<option value="',WCN.map.field_options[e][i].value,'"');for(var s=0;s<n.length;s++)if(WCN.map.field_options[e][i].value==n[s]){r.push(' selected="selected"');break}r.push(">",WCN.map.field_options[e][i].label,"</option>"),WCN.map.field_options[e][i].added="1"}t.html(r.join("")),t.data("select2")&&t.closest(".form_value").is(":visible")&&t.trigger("change",[{first_run:1,set_field_options:!0}])}else if("checkbox"==d.type||"radio"==d.type){var f=null,p=d,_=null;if(null==(_=null==d?idOrName:d.name))return null;for(var u=document.getElementsByTagName("input"),i=0;i<u.length;i++)for(var m=u[i],l=0;l<a.length;l++)if(("checkbox"==m.type||"radio"==m.type)&&m.name==_){if(m.value==a[l]){m.disabled=!1;break}m.disabled=!0}return f}}},new_select_values:function(e,a){var t=$("#"+e),d=t.get(0);d.disabled=!1;var n=WCN.formtools.get_field_values(e);if("select-one"==d.type||"select-multiple"==d.type){d&&d.options&&d.options[0]&&d.options[0].innerHTML&&""===d.options[0].value?d.options.length=1:d.options.length=0;for(var i=0;i<a.length;i++){var o=document.createElement("option");o.setAttribute("value",a[i].v),o.innerHTML=a[i].l,d.appendChild(o)}t.data("select2")&&t.closest(".form_value").is(":visible")&&t.trigger("change",[{first_run:1,set_field_options:!0}])}},get_field_values:function(e){var a=$("#"+e),t=a.get(0);if(a.is(":disabled"))return"-1";if(!t){if($("input[name="+e+"]").get(0)){var d=[];return $("input[name="+e+"]:checked").each(function(){d.push($(this).val())}),d}return"-1"}if(a.data("select2")){var n=new Array,i=a.select2("val");return $.isArray(i)?n.push.apply(n,i):n.push(i),n}if("select-one"==t.type||"select-multiple"==t.type){for(var n=new Array,o=0;o<t.options.length;o++)t.options[o].selected&&""!=t.options[o].value&&n.push(t.options[o].value);return n}return"text"==t.type||"textarea"==t.type||"hidden"==t.type?t.value:"checkbox"==t.type&&t.checked?t.value:void 0},enableInLineHelp:function(){$("a.field-info").each(function(e,a){var t=$(a);t.children("img").attr("alt","");var d={length:0};t.attr("title","").hover(function(){if(d.length)d.length&&d.stop().fadeTo("fast",1);else{d=$("<span />",{class:"field_help_text"}).hide().load(a.href+" #cn",function(e){d.stop().fadeIn("fast").show()});var e=t.offset();d.css({border:"1px solid black",padding:"5px","border-radius":"5px","background-color":"white",position:"absolute",left:e.left+25,top:e.top}),$("body").append(d)}},function(){d.length&&d.stop().fadeOut("fast")}).click(function(e){e.preventDefault()})})}};